from flask import Flask, render_template_string, request, jsonify
import random
from sympy import isprime

app = Flask(__name__)

WORD_LENGTH = 5
MAX_ATTEMPTS = 10
FIVE_DIGIT_PRIMES = [str(num) for num in range(10000, 100000) if isprime(num)]

HTML_TEMPLATE = """
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Numble</title>
    <style>
        body { background: #121213; color: white; font-family: Arial, sans-serif; text-align: center; }
        .grid { display: grid; grid-template-columns: repeat(5, 60px); gap: 10px; justify-content: center; margin-top: 40px; }
        .cell { width: 60px; height: 60px; font-size: 36px; font-weight: bold; background: #3a3a3c; color: white; display: flex; align-items: center; justify-content: center; border-radius: 4px; }
        .correct { background: #6aaa64; }
        .present { background: #c9b458; }
        .absent { background: #787c7e; }
        input { font-size: 20px; padding: 10px; width: 200px; margin-top: 20px; }
        button { padding: 10px 20px; font-size: 16px; background-color: #538d4e; color: white; border: none; cursor: pointer; }
    </style>
</head>
<body>
    <h1>Numble</h1>
    <div id="grid"></div>
    <input type="text" id="guess" maxlength="5" placeholder="Enter 5-digit prime">
    <button onclick="submitGuess()">Guess</button>
    <button onclick="getHint()">Hint</button>
    <p id="message"></p>

    <script>
        let attempts = 0;
        const maxAttempts = {{ max_attempts }};

        function createRow(guess, feedback) {
            const grid = document.getElementById('grid');
            const row = document.createElement('div');
            row.className = 'grid';
            for (let i = 0; i < guess.length; i++) {
                const cell = document.createElement('div');
                cell.className = 'cell ' + feedback[i];
                cell.innerText = guess[i];
                row.appendChild(cell);
            }
            grid.appendChild(row);
        }

        function submitGuess() {
            const guess = document.getElementById('guess').value;
            fetch('/guess', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ guess })
            })
            .then(res => res.json())
            .then(data => {
                if (data.error) {
                    document.getElementById('message').innerText = data.error;
                    return;
                }
                createRow(data.guess, data.feedback);
                document.getElementById('message').innerText = data.message;
                document.getElementById('guess').value = '';
            });
        }

        function getHint() {
            fetch('/hint')
            .then(res => res.json())
            .then(data => {
                document.getElementById('message').innerText = data.hint;
            });
        }
    </script>
</body>
</html>
"""

target_number = random.choice(FIVE_DIGIT_PRIMES)
guess_history = []

def get_feedback(guess, target):
    feedback = []
    for i in range(len(guess)):
        if guess[i] == target[i]:
            feedback.append('correct')
        elif guess[i] in target:
            feedback.append('present')
        else:
            feedback.append('absent')
    return feedback

@app.route("/")
def home():
    return render_template_string(HTML_TEMPLATE, max_attempts=MAX_ATTEMPTS)

@app.route("/guess", methods=["POST"])
def guess():
    global guess_history, target_number
    data = request.get_json()
    guess = data.get("guess", "")

    if len(guess) != WORD_LENGTH or not guess.isdigit():
        return jsonify({"error": "Please enter a 5-digit number."})
    if not isprime(int(guess)):
        return jsonify({"error": "Not a valid 5-digit prime number."})
    if len(guess_history) >= MAX_ATTEMPTS:
        return jsonify({"error": "No more attempts left!"})

    feedback = get_feedback(guess, target_number)
    guess_history.append((guess, feedback))

    if guess == target_number:
        return jsonify({"guess": guess, "feedback": feedback, "message": "Congratulations! You guessed it! ðŸŽ‰"})
    elif len(guess_history) >= MAX_ATTEMPTS:
        return jsonify({"guess": guess, "feedback": feedback, "message": f"Game Over! The number was {target_number}."})
    else:
        return jsonify({"guess": guess, "feedback": feedback, "message": "Try again!"})

@app.route("/hint")
def hint():
    if len(guess_history) < 3:
        return jsonify({"hint": "Hints unlock after 3 attempts!"})
    unrevealed = [i for i in range(WORD_LENGTH) if all(g[i] != target_number[i] for g, _ in guess_history)]
    if unrevealed:
        i = random.choice(unrevealed)
        return jsonify({"hint": f"Digit {i+1} is {target_number[i]}"})
    return jsonify({"hint": "All digits have been revealed."})

if __name__ == "__main__":
    app.run(debug=True)
